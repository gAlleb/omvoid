#!/bin/bash

# Cycles through the background images available
CACHE_DIR="$HOME/.cache/omvoid_wallpaper"
BACKGROUNDS_DIR="$HOME/.config/omvoid/current/theme/backgrounds/"
CURRENT_BACKGROUND_LINK="$HOME/.config/omvoid/current/background"

mapfile -d '' -t BACKGROUNDS < <(find "$BACKGROUNDS_DIR" -type f -print0 | sort -z)
TOTAL=${#BACKGROUNDS[@]}

if [[ $TOTAL -eq 0 ]]; then
  notify-send "No background was found for theme" -t 2000
  pkill -x swaybg
  swww clear '#000000' >/dev/null 2>&1 &
else
  # Get current background from symlink
  if [[ -L "$CURRENT_BACKGROUND_LINK" ]]; then
    CURRENT_BACKGROUND=$(readlink "$CURRENT_BACKGROUND_LINK")
  else
    # Default to first background if no symlink exists
    CURRENT_BACKGROUND=""
  fi

  # Find current background index
  INDEX=-1
  for i in "${!BACKGROUNDS[@]}"; do
    if [[ "${BACKGROUNDS[$i]}" == "$CURRENT_BACKGROUND" ]]; then
      INDEX=$i
      break
    fi
  done

  # Get next background (wrap around)
  if [[ $INDEX -eq -1 ]]; then
    # Use the first background when no match was found
    NEW_BACKGROUND="${BACKGROUNDS[0]}"
  else
    NEXT_INDEX=$(((INDEX + 1) % TOTAL))
    NEW_BACKGROUND="${BACKGROUNDS[$NEXT_INDEX]}"
  fi

  # Set new background symlink
  ln -nsf "$NEW_BACKGROUND" "$CURRENT_BACKGROUND_LINK"

  swww img --transition-type any --transition-angle 45 "$CURRENT_BACKGROUND_LINK"
  
  # Create thumbnail
  CURRENT_BACKGROUND_DIR=$(dirname "$CURRENT_BACKGROUND_LINK")
  CURRENT_BACKGROUND_BASENAME=$(basename "$CURRENT_BACKGROUND_LINK")
  FILENAME_NO_EXT="${CURRENT_BACKGROUND_BASENAME%.*}"
  THUMBNAIL_PATH="${CURRENT_BACKGROUND_DIR}/${FILENAME_NO_EXT}_thumbnail.png"
  magick "$CURRENT_BACKGROUND_LINK" -thumbnail '320x180>' "$THUMBNAIL_PATH"

  echo "\$wallpaper = $CURRENT_BACKGROUND_LINK" > $CACHE_DIR/wallpaper-hyprland.conf
  echo "\$wallpaper_thumbnail = $THUMBNAIL_PATH" > $CACHE_DIR/wallpaper_thumbnail
  echo "inputbar { background-image: url(\"$THUMBNAIL_PATH\", width); }" > $CACHE_DIR/wallpaper_thumbnail.rasi
  echo "$CURRENT_BACKGROUND_LINK" > "${CURRENT_WALLPAPER_PATH_FILE}"
  magick "$CURRENT_BACKGROUND_LINK" ~/.config/bg.jpg
fi 
