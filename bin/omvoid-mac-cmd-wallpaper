#!/bin/bash

# --- CONFIGURATION ---
# Use absolute path (replace /Users/yourname if $HOME fails in AppleScript)
export PATH="/Library/Frameworks/Python.framework/Versions/3.14/bin:${PATH}"
WALL_DIR="$HOME/.config/wallpaper"
# --- MAIN ---
main() {
    # check if dir exists
    if [ ! -d "$WALL_DIR" ]; then
        osascript -e "display notification \"Folder not found\" with title \"Error\""
        exit 1
    fi

    # 1. Open the Native File Picker
    # 'default location': opens exactly in your folder
    # 'of type': restricts files to images only (no hidden system files)
    # 'invisibles': false hides dotfiles
    
    FILE_PATH=$(osascript -e "
        set wallPath to POSIX file \"$WALL_DIR\"
        try
            set selectedFile to choose file \
                with prompt \"Choose a Wallpaper:\" \
                default location wallPath \
                of type {\"public.image\"} \
                invisibles false \
                without multiple selections allowed
            return POSIX path of selectedFile
        on error
            return \"false\"
        end try
    ")

    # 2. Check if user cancelled
    if [ "$FILE_PATH" = "false" ] || [ -z "$FILE_PATH" ]; then
        exit 0
    fi

    # 3. Set the Wallpaper
    osascript -e "tell application \"System Events\"
        set picture of every desktop to POSIX file \"$FILE_PATH\"
    end tell"

    wal -n -i "$FILE_PATH"
    /usr/local/bin/sketchybar --reload
    /usr/local/bin/aerospace reload-config
    kitty @ set-colors -a "$HOME/.cache/wal/colors-kitty.conf"
    
    # Optional: Notify
    # osascript -e "display notification \"Wallpaper updated!\" with title \"Success\""
}

main
