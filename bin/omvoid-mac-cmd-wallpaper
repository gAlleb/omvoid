#!/bin/bash

export PATH="/Library/Frameworks/Python.framework/Versions/3.14/bin:${PATH}"
WALL_DIR="$HOME/.config/wallpaper"

main() {
    # check if dir exists
    if [ ! -d "$WALL_DIR" ]; then
        osascript -e "display notification \"Folder not found\" with title \"Error\""
        exit 1
    fi

    FILE_PATH=$(osascript -e "
        set wallPath to POSIX file \"$WALL_DIR\"
        try
            set selectedFile to choose file \
                with prompt \"Choose a Wallpaper:\" \
                default location wallPath \
                of type {\"public.image\"} \
                invisibles false \
                without multiple selections allowed
            return POSIX path of selectedFile
        on error
            return \"false\"
        end try
    ")

    if [ "$FILE_PATH" = "false" ] || [ -z "$FILE_PATH" ]; then
        exit 0
    fi

    osascript -e "tell application \"System Events\"
        set picture of every desktop to POSIX file \"$FILE_PATH\"
    end tell"

    wal -n -i "$FILE_PATH"
    /usr/local/bin/sketchybar --reload
    /usr/local/bin/aerospace reload-config
    kitty @ set-colors -a "$HOME/.cache/wal/colors-kitty.conf"
    
    # Optional: Notify
    # osascript -e "display notification \"Wallpaper updated!\" with title \"Success\""
}

main
